.row#carbon-races
  .large-12.columns
    %h2 Play the Carbon Race
    %p<
      The Carbon Race is fun competition to see which business, club, neighborhood or other organization offset the most carbon.  You can join an existing team, or create one of your own.
  -if @team
    .large-12.columns#change-team{:style=>'display:none'}
      %h4 Change your team
      =select_tag :team, options_from_collection_for_select(@teams, 'id', 'name', @team.id), id: 'select-new-team', prompt: 'Which team?'
      
      #new-team-msg
    .large-12.columns
      %h4.team-msg Your offset of #{@offsets.sum(&:pounds)} lbs has been added to the tally for Team '#{@team.name}'
      %p=link_to "Click here to change the team you are playing for", "#", :class => 'change-team'

  -elsif @individual
    .large-12.columns
      %h4 Your offset of #{@offset_data[:pounds]} lbs has been added to your individual tally
  -else
    #race-actions
      .large-4.columns{:style=>'text-align:center;'}
        %button#join Contribute to Team
        %span Your offset will count towards the team stats
      .large-4.columns{:style=>'text-align:center;'}
        %button#create Create New Team
        %span Found a new team and add your recent offset
      .large-4.columns{:style=>'text-align:center;'}
        %button#individual-player Play as Individual
        %span Compete against others without a team
  -if @team.present?

  -else
    .row
      .large-12.columns#msg
      #team-actions{:style=>'display:none'}
        .large-6.medium-6.columns#create-team
          %h4 Create a  Team
          %p Anyone can make a team for their organization and invite others to join it
          =form_for :team, :url=>teams_path, :remote=>:true, :html=> {:id=>'new-team'} do |f|
            %label Team Name
            =f.text_field :name, id: 'team-name'
            %label Your Name (for public display)
            =text_field_tag :member_name, '', id: 'public-name'
            =hidden_field_tag :checkout_session_id, @checkout_session
            -#=f.file_field :image, :class => 'file-upload'
            #form-msg
            %br
            =f.submit 'submit', :class=>'button'


        .large-6.medium-6.columns#join-team
          %h4 Join a  Team
          %p Are others in your organization already playing?  Join them!
          =select_tag :team, options_from_collection_for_select(@teams, 'id', 'name'), id: 'select-team', prompt: 'Select a team to join'
          =hidden_field_tag :checkout_session_id, @checkout_session
          #member-name
            %label Your Name (for public display)
            =text_field_tag :name, nil, :id=> 'team-member-name'
            #join-msg
            %button#submit-name Join Team
      #individual-actions{:style=>'display:none'}
        .large-12.columns
          %h4 Play Solo
          %p Rise up the charts each time you offset
          =hidden_field_tag :checkout_session_id, @checkout_session
          %label Your Name (for public display)
          =text_field_tag :name, nil, :id=> 'player-name'
          %button#new-player Register 
  .large-12.columns
    %a#skip 
      %h3 Spin Prize Wheel >
.row#prize-wheel{:style=>"display:none;"}
  .large-6.medium-6.columns
    %h3 Prize Wheel
    %p Spin after each offset for a shot at prizes from local businesses!
    #spin
      Spin Wheel
    #award{:style=>'display:none'}
      you have won an award
  .large-6.medium-6.columns

    #wheel
      .cycle-slideshow{"data-paused" => "true", "data-cycle-speed" => "100"}
        -@prizes.each do |p|
          -@count=0
          -p.count.times do
            =render :partial => 'prizes/spot', :locals => {prize:p}
            -@count = @count + 1
        -@empties.times do
          =image_tag('footprint.jpg', :'data-name'=>'Nothing')
          -@count = @count + 1
        :javascript
          var total_spots = "#{@count}";

  .large-6.medium-6.columns

:javascript
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const checkout_session_id = urlParams.get('checkout_session_id');
  $('#player-name').val("#{@offsets.first.name}");
  $('#public-name').val("#{@offsets.first.name}");

  $('.change-team').on('click',function() {
    $('#race-actions').hide();
    $('#change-team').show();
  })

  $('#new-team').submit(function(event) {

    if(!$('#team-name').val() || !$('#public-name').val()) {
      $('#form-msg').text('Please provide a team name and your name.');
      return false;
    }

  });

  $('#create').on('click',function() {
    $('#team-actions').show();
    $('#race-actions').hide();
    $('#create-team').insertBefore('#join-team');
  })
  $('#join').on('click',function() {
    $('#race-actions').hide();
    $('#team-actions').show();
    $('#join-team').insertBefore('#create-team');
  })

  $('#individual-player').on("click", function() {
    $('#individual-actions').show();
  });

  $('#select-team').on('change', function() {

    $('#member-name').show();

  });

  $('#skip').on('click', function() {

    $('#prize-wheel').show();
    $('#carbon-races').hide();

  });


  $('#submit-name').on('click', function() {
    if(!$('#team-member-name').val()) {
      $('#join-msg').text('Please provide your name.');
    }
    else {
      team_data = {}
      team_data.name = $('#team-member-name').val();
      team_data.checkout_session_id = checkout_session_id;
      $.post('/teams/'+ $('#select-team').val() + '/join', team_data);
    }

  });



  $('#new-player').on('click', function() {
    if(!$('#player-name').val()) {
      $('#player-msg').text('Please provide a name to publicly display.');
    }
    else {
      team_data = {}
      team_data.name = $('#player-name').val();
      $.post('/individuals/', {individual:team_data, checkout_session_id:checkout_session_id});
    }

  });

  // for prize wheel
  var spin;
  count = 0;
  var prize_id;

  $.fn.shuffleChildren = function() {
      $.each(this.get(), function(index, el) {
          var $el = $(el);
          var $find = $el.children();

          $find.sort(function() {
              return 0.5 - Math.random();
          });

          $el.empty();
          $find.appendTo($el);
      });
  };
  $('.cycle-slideshow').shuffleChildren();

  $('#spin').on('click',function() {
    spin = setInterval(cycleWheel, 250);
    count = 0;
    $.get("#{log_spin_path}");
    $('#spin').hide();
    $('#wheel').show();
  });

  function cycleWheel() {
    $('.cycle-slideshow').cycle('next');
    count++;

    if(count == 20) {

      clearInterval(spin);
      $('#award').show();
      val = $('.cycle-slideshow').data("cycle.opts").currSlide;
      prize_id = parseInt($('.cycle-slide-active').data('prize-id'));
      if(prize_id > 0) {
        prize_id = $('.cycle-slide-active').data('prize-id');
        
        $.post('#{prize_winners_path}', {prize: $('.cycle-slide-active').data('prize-id'), checkout_session_id: "#{@checkout_session}"}, function() {
          $('#award').html('Congrats, you won a ' + $('.cycle-slide-active').data('name') + '! Check your email for details on claiming prize.');        
        });
      }
      else {
        $('#award').html('Sorry, you did not win anything, but you can try again next time you make an offset!');
        $('#carbon-race-button').show();
      }
    }
  }


-if @team.present?
  :javascript

    $('#select-new-team').on('change', function() {

      team_data =  {new_team_id: $(this).val(), old_team_id: '#{@team.id}', checkout_session_id: checkout_session_id};
      $.post('#{change_teams_path}', team_data);

    });
